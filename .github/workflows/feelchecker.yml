name: feelchecker

# ────────────── トリガー ──────────────
on:
  schedule:
    # 15 分おき
    - cron: '*/15 * * * *'
  workflow_dispatch:       # 手動実行

# ────────────── ジョブ ──────────────
jobs:
  run:
    runs-on: ubuntu-22.04

    steps:
      # ① ソース取得
      - uses: actions/checkout@v4

      # ② Python セットアップ
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ③ SHEET_CSV の長さ & 制御文字を確認（デバッグ用）
      - name: Debug SHEET_CSV
        shell: bash
        run: |
          echo "▶︎ len=$(echo -n "$SHEET_CSV" | wc -c) bytes"
          printf '▶︎ hex ='
          echo -n "$SHEET_CSV" | od -An -tx1 | head -n 1

      # ④ CSV 先頭 2 行を表示（取得チェック）
      - name: Check CSV head
        shell: bash
        run: |
          echo "=== CSV head ==="
          curl -sL "$SHEET_CSV" | head -n 2
          echo "================"

      # ⑤ 依存ライブラリ + Playwright ブラウザ
      - name: Install Python deps & Playwright browsers
        run: |
          python -m pip install -r requirements.txt
          playwright install --with-deps

      # ⑥ feelchecker 実行
      - name: Run feelchecker
        run: python feelchecker.py
        env:
          FEEL_USER: ${{ secrets.FEEL_USER }}
          FEEL_PASS: ${{ secrets.FEEL_PASS }}
          SHEET_CSV: ${{ secrets.SHEET_CSV }}
          CH_ACCESS: ${{ secrets.CH_ACCESS }}
