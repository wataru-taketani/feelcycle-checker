name: feelchecker

on:
  schedule:
    - cron: '*/15 * * * *'    # 15 分ごと
  workflow_dispatch:          # 手動実行

jobs:
  run:
    runs-on: ubuntu-22.04

    # ── 👇 ここで一括指定すると 以降すべてのステップで参照可能 ──
    env:
      FEEL_USER: ${{ secrets.FEEL_USER }}
      FEEL_PASS: ${{ secrets.FEEL_PASS }}
      SHEET_CSV: ${{ secrets.SHEET_CSV }}
      CH_ACCESS: ${{ secrets.CH_ACCESS }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Secrets が渡っているか確認
      - name: Debug SHEET_CSV
        shell: bash
        run: |
          echo "▶ len=$(echo -n "$SHEET_CSV" | wc -c) bytes"
          printf '▶ hex ='
          echo -n "$SHEET_CSV" | od -An -tx1 | head -n 1

      # CSV が取れるか確認
      - name: Check CSV head
        shell: bash
        run: |
          echo "=== CSV head ==="
          curl -sL "$SHEET_CSV" | head -n 2
          echo "================"

      # 依存ライブラリ + Playwright
      - name: Install Python deps & Playwright browsers
        run: |
          python -m pip install -r requirements.txt
          playwright install --with-deps

      # 本処理
      - name: Run feelchecker
        run: python feelchecker.py
